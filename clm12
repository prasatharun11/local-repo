private static List<String> partitionChunks(List<String> entries, int chunkLimit, boolean byLength, int numChunks) {
    List<String> chunks = new ArrayList<>(Collections.nCopies(numChunks, ""));
    int chunkIndex = 0;
    StringBuilder current = new StringBuilder();

    if (byLength) {
        for (String entry : entries) {
            String text = entry;
            while (!text.isEmpty() && chunkIndex < numChunks) {
                int space = chunkLimit - current.length();
                if (space <= 0) { // finalize
                    chunks.set(chunkIndex++, current.toString());
                    current.setLength(0);
                    continue;
                }
                int split = text.length() <= space ? text.length() : findSafeSplitIndex(text, space);
                if (split == 0) { // cannot split safely
                    if (current.length() > 0) {
                        chunks.set(chunkIndex++, current.toString());
                        current.setLength(0);
                        continue;
                    }
                    split = text.length(); // force entire entry
                }
                current.append(text, 0, split);
                text = text.substring(split);
            }
            if (chunkIndex >= numChunks) break;
        }
        if (chunkIndex < numChunks && current.length() > 0)
            chunks.set(chunkIndex++, current.toString());
    } else { 
        AtomicInteger counter = new AtomicInteger();
        entries.stream()
               .collect(Collectors.groupingBy(i -> counter.getAndIncrement() / chunkLimit))
               .forEach((idx, group) -> {
                   if (idx < numChunks) {
                       String joined = String.join("", group);
                       chunks.set(idx, joined.endsWith("~") ? joined : joined + "~");
                   }
               });
    }

    // Fill empty chunks with "~"
    for (int i = 0; i < numChunks; i++)
        if (chunks.get(i).isEmpty()) chunks.set(i, "~");

    // Adjust for chunks starting with ~ or |
    for (int i = 1; i < numChunks; i++) {
        String cur = chunks.get(i), prev = chunks.get(i - 1);
        if (cur.startsWith("~") && !prev.isEmpty()) {
            int last = prev.lastIndexOf('~');
            if (last != -1 && last < prev.length() - 1) {
                chunks.set(i - 1, prev.substring(0, last + 1));
                chunks.set(i, prev.substring(last + 1) + cur.substring(1));
            }
        } else if (cur.startsWith("|") && !prev.isEmpty()) {
            int last = prev.lastIndexOf('|');
            if (last != -1) {
                chunks.set(i - 1, prev.substring(0, last));
                chunks.set(i, prev.substring(last) + cur.substring(1));
            }
        }
    }

    return chunks;
}