import java.io.*;
import java.nio.file.*;
import java.util.*;
import java.util.regex.*;

public class DuplicateAttributeChecker {

    // Regex pattern to match HTML tags (e.g., <button ...>).
    private static final Pattern TAG_PATTERN = Pattern.compile("<(\\w+)([^>]*)>");
    // Regex pattern to match HTML attributes (e.g., id="value").
    private static final Pattern ATTRIBUTE_PATTERN = Pattern.compile("(\\w+)\\s*=\\s*\"[^\"]*\"");
    // Regex pattern to match JSP Java code blocks (e.g., <% ... %>, <%= ... %>, <%! ... %>).
    private static final Pattern JSP_CODE_BLOCK_PATTERN = Pattern.compile("<%[^>]*%>");
    // Regex pattern to match closing tags (e.g., </button>).
    private static final Pattern CLOSING_TAG_PATTERN = Pattern.compile("</\\w+>");

    public static void main(String[] args) {
        String directoryPath = "/path/to/your/jsp/files"; // Provide your directory path here

        try {
            Files.walk(Paths.get(directoryPath))
                 .filter(Files::isRegularFile)
                 .filter(path -> path.toString().endsWith(".jsp"))
                 .forEach(DuplicateAttributeChecker::processFile);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private static void processFile(Path filePath) {
        try (BufferedReader reader = Files.newBufferedReader(filePath)) {
            String line;
            int lineNumber = 0;

            StringBuilder currentTag = new StringBuilder();
            String currentTagName = "";
            int openTagCount = 0;

            while ((line = reader.readLine()) != null) {
                lineNumber++;
                // Remove JSP Java code blocks before processing for HTML tags.
                String sanitizedLine = removeJspCodeBlocks(line);
                Matcher tagMatcher = TAG_PATTERN.matcher(sanitizedLine);

                while (tagMatcher.find()) {
                    currentTagName = tagMatcher.group(1);
                    currentTag.setLength(0); // Clear the StringBuilder for new tag
                    currentTag.append(tagMatcher.group(0)); // Start with the found opening tag
                    openTagCount++;
                }

                // Check for closing tags
                Matcher closingTagMatcher = CLOSING_TAG_PATTERN.matcher(sanitizedLine);
                while (closingTagMatcher.find()) {
                    if (openTagCount > 0 && closingTagMatcher.group(0).equals("</" + currentTagName + ">")) {
                        openTagCount--;
                        checkForDuplicateAttributes(currentTag.toString(), filePath.toString(), lineNumber);
                        currentTag.setLength(0); // Clear for next tag
                    }
                }

                // If the current line contains part of an open tag, append it
                if (openTagCount > 0) {
                    currentTag.append(" ").append(sanitizedLine.trim());
                }
            }

            // Final check for any unclosed tags in case file ends without closing
            if (openTagCount > 0) {
                checkForDuplicateAttributes(currentTag.toString(), filePath.toString(), lineNumber);
            }

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    // Remove JSP scriptlets, expressions, and declarations from the line to avoid interference.
    private static String removeJspCodeBlocks(String line) {
        Matcher jspMatcher = JSP_CODE_BLOCK_PATTERN.matcher(line);
        return jspMatcher.replaceAll("");  // Replace JSP code blocks with an empty string.
    }

    // Check for duplicate attributes within the HTML tag.
    private static void checkForDuplicateAttributes(String tag, String fileName, int lineNumber) {
        Matcher attributeMatcher = ATTRIBUTE_PATTERN.matcher(tag);
        Map<String, Integer> attributes = new HashMap<>();

        while (attributeMatcher.find()) {
            String attributeName = attributeMatcher.group(1);
            if (attributes.containsKey(attributeName)) {
                // Print a message if a duplicate attribute is found.
                System.out.printf("Duplicate attribute '%s' found in file %s at line %d%n", 
                                  attributeName, fileName, lineNumber);
            } else {
                attributes.put(attributeName, attributeMatcher.start());
            }
        }
    }
}